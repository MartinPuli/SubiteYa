generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                       String             @id @default(uuid())
  email                    String             @unique
  name                     String
  passwordHash             String             @map("password_hash")
  passwordSalt             String             @map("password_salt")
  role                     String             @default("user")
  tier                     String?            @default("free")
  language                 String             @default("es")
  timezone                 String             @default("UTC")
  createdAt                DateTime           @default(now()) @map("created_at")
  updatedAt                DateTime           @updatedAt @map("updated_at")
  acceptedPrivacyAt        DateTime?          @map("accepted_privacy_at")
  acceptedTermsAt          DateTime?          @map("accepted_terms_at")
  emailVerificationCode    String?            @map("email_verification_code")
  emailVerificationExp     DateTime?          @map("email_verification_exp")
  emailVerified            Boolean            @default(false) @map("email_verified")
  passwordResetCode        String?            @map("password_reset_code")
  passwordResetExp         DateTime?          @map("password_reset_exp")
  acceptedTermsVersion     String?            @map("accepted_terms_version") @db.VarChar(10)
  acceptedPrivacyVersion   String?            @map("accepted_privacy_version") @db.VarChar(10)
  auditEvents              AuditEvent[]
  brandPatterns            BrandPattern[]
  publishBatches           PublishBatch[]
  publishJobs              PublishJob[]
  tiktokConnections        TikTokConnection[]
  videoAssets              VideoAsset[]
  videos                   Video[]
  designProfiles           DesignProfile[]

  @@map("users")
}

model TikTokConnection {
  id              String         @id @default(uuid())
  userId          String         @map("user_id")
  openId          String         @unique @map("open_id")
  displayName     String         @map("display_name")
  avatarUrl       String?        @map("avatar_url")
  scopeGranted    String[]       @map("scope_granted")
  accessTokenEnc  String         @map("access_token_enc")
  refreshTokenEnc String         @map("refresh_token_enc")
  expiresAt       DateTime       @map("expires_at")
  isDefault       Boolean        @default(false) @map("is_default")
  designId        String?        @map("design_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  patterns        BrandPattern[]
  publishJobs     PublishJob[]
  videos          Video[]
  design          DesignProfile? @relation(fields: [designId], references: [id])
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([designId])
  @@map("tiktok_connections")
}

model VideoAsset {
  id               String         @id @default(uuid())
  userId           String         @map("user_id")
  storageUrl       String         @map("storage_url")
  originalFilename String         @map("original_filename")
  sizeBytes        BigInt         @map("size_bytes")
  durationSec      Int?           @map("duration_sec")
  checksum         String
  status           String         @default("uploaded")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  publishBatches   PublishBatch[]
  publishJobs      PublishJob[]
  user             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("video_assets")
}

model PublishBatch {
  id              String       @id @default(uuid())
  userId          String       @map("user_id")
  videoAssetId    String       @map("video_asset_id")
  defaultsJson    Json         @map("defaults_json")
  scheduleTimeUtc DateTime?    @map("schedule_time_utc")
  createdAt       DateTime     @default(now()) @map("created_at")
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  videoAsset      VideoAsset   @relation(fields: [videoAssetId], references: [id])
  jobs            PublishJob[]

  @@index([userId])
  @@index([scheduleTimeUtc])
  @@map("publish_batches")
}

model PublishJob {
  id                 String           @id @default(uuid())
  batchId            String           @map("batch_id")
  userId             String           @map("user_id")
  tiktokConnectionId String           @map("tiktok_connection_id")
  videoAssetId       String           @map("video_asset_id")
  caption            String?
  hashtags           String[]         @default([])
  privacyStatus      String           @default("public") @map("privacy_status")
  allowDuet          Boolean          @default(true) @map("allow_duet")
  allowStitch        Boolean          @default(true) @map("allow_stitch")
  allowComment       Boolean          @default(true) @map("allow_comment")
  scheduleTimeUtc    DateTime?        @map("schedule_time_utc")
  state              String           @default("queued")
  attempts           Int              @default(0)
  lastAttemptAt      DateTime?        @map("last_attempt_at")
  backoffSec         Int?             @map("backoff_sec")
  tiktokVideoId      String?          @map("tiktok_video_id")
  errorCode          String?          @map("error_code")
  errorMessage       String?          @map("error_message")
  idempotencyKey     String           @unique @map("idempotency_key")
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")
  batch              PublishBatch     @relation(fields: [batchId], references: [id], onDelete: Cascade)
  tiktokConnection   TikTokConnection @relation(fields: [tiktokConnectionId], references: [id], onDelete: Cascade)
  user               User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  videoAsset         VideoAsset       @relation(fields: [videoAssetId], references: [id])

  @@index([batchId])
  @@index([userId])
  @@index([state])
  @@index([scheduleTimeUtc])
  @@map("publish_jobs")
}

model AuditEvent {
  id          String   @id @default(uuid())
  userId      String?  @map("user_id")
  type        String
  detailsJson Json     @map("details_json")
  ip          String?
  userAgent   String?  @map("user_agent")
  createdAt   DateTime @default(now()) @map("created_at")
  user        User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("audit_events")
}

model WebhookEvent {
  id             String    @id @default(uuid())
  provider       String
  eventType      String    @map("event_type")
  payloadJson    Json      @map("payload_json")
  signatureValid Boolean   @map("signature_valid")
  processed      Boolean   @default(false)
  createdAt      DateTime  @default(now()) @map("created_at")
  processedAt    DateTime? @map("processed_at")

  @@index([provider])
  @@index([processed])
  @@index([createdAt])
  @@map("webhook_events")
}

model BrandPattern {
  id                   String           @id @default(uuid())
  userId               String           @map("user_id")
  tiktokConnectionId   String           @map("tiktok_connection_id")
  name                 String
  isDefault            Boolean          @default(false) @map("is_default")
  version              Int              @default(1)
  logoUrl              String?          @map("logo_url")
  logoPosition         String           @default("bottom-right") @map("logo_position")
  logoSize             Int              @default(15) @map("logo_size")
  logoOpacity          Int              @default(100) @map("logo_opacity")
  thumbnailUrl         String?          @map("thumbnail_url")
  createdAt            DateTime         @default(now()) @map("created_at")
  updatedAt            DateTime         @updatedAt @map("updated_at")
  brightness           Int              @default(100) @map("brightness")
  contrast             Int              @default(100) @map("contrast")
  enableEffects        Boolean          @default(false) @map("enable_effects")
  enableSubtitles      Boolean          @default(false) @map("enable_subtitles")
  filterType           String           @default("none") @map("filter_type")
  saturation           Int              @default(100) @map("saturation")
  subtitleBgColor      String           @default("#000000") @map("subtitle_bg_color")
  subtitleColor        String           @default("#FFFFFF") @map("subtitle_color")
  subtitleFontSize     Int              @default(24) @map("subtitle_font_size")
  subtitlePosition     String           @default("bottom") @map("subtitle_position")
  subtitleStyle        String           @default("modern") @map("subtitle_style")
  audio_normalize      Boolean          @default(false)
  audio_volume         Int              @default(100)
  bg_music_url         String?
  bg_music_volume      Int              @default(50)
  blur                 Int              @default(0)
  crop_position        String           @default("center")
  denoise_strength     Int              @default(50)
  description          String?
  enable_audio_enhance Boolean          @default(false)
  enable_auto_crop     Boolean          @default(false)
  enable_bg_music      Boolean          @default(false)
  enable_color_grading Boolean          @default(false)
  enable_denoise       Boolean          @default(false)
  enable_smooth_slow   Boolean          @default(false)
  enable_stabilization Boolean          @default(false)
  exposure             Int              @default(100)
  grain                Int              @default(0)
  highlights           Int              @default(100)
  hue                  Int              @default(0)
  output_bitrate       String           @default("auto")
  output_fps           Int              @default(30)
  output_quality       String           @default("high")
  preview_video_url    String?
  shadows              Int              @default(100)
  sharpen              Int              @default(0)
  speed_multiplier     Float            @default(1.0)
  subtitle_animation   String           @default("none")
  subtitle_font_family String           @default("Inter")
  target_aspect_ratio  String           @default("original")
  temperature          Int              @default(100)
  tint                 Int              @default(100)
  transition_duration  Float            @default(0.5)
  transition_type      String           @default("none")
  vignette             Int              @default(0)
  tiktokConnection     TikTokConnection @relation(fields: [tiktokConnectionId], references: [id], onDelete: Cascade)
  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tiktokConnectionId])
  @@index([isDefault])
  @@map("brand_patterns")
}

// ========================================
// NEW: Video Queue System
// ========================================

enum VideoStatus {
  DRAFT
  EDITING_QUEUED
  EDITING
  EDITED
  UPLOAD_QUEUED
  UPLOADING
  POSTED
  FAILED_EDIT
  FAILED_UPLOAD
}

model DesignProfile {
  id          String             @id @default(cuid())
  userId      String             @map("user_id")
  name        String
  version     Int                @default(1)
  specJson    Json               @map("spec_json")
  active      Boolean            @default(true)
  createdAt   DateTime           @default(now()) @map("created_at")
  updatedAt   DateTime           @updatedAt @map("updated_at")
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  accounts    TikTokConnection[]
  videos      Video[]

  @@index([userId])
  @@index([active])
  @@map("design_profiles")
}

model Video {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  accountId    String?      @map("account_id")
  status       VideoStatus  @default(DRAFT)
  srcUrl       String       @map("src_url")
  editedUrl    String?      @map("edited_url")
  postUrl      String?      @map("post_url")
  designId     String?      @map("design_id")
  editSpecJson Json?        @map("edit_spec_json")
  thumbnailUrl String?      @map("thumbnail_url")
  duration     Float?
  title        String?
  error        String?
  progress     Int          @default(0)
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  account      TikTokConnection? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  design       DesignProfile?    @relation(fields: [designId], references: [id], onDelete: SetNull)
  jobs         Job[]

  @@index([userId])
  @@index([accountId])
  @@index([status])
  @@index([createdAt])
  @@map("videos")
}

model Job {
  id         String    @id @default(cuid())
  videoId    String    @map("video_id")
  type       String    // "edit" | "upload"
  status     String    @default("queued") // "queued" | "running" | "succeeded" | "failed"
  attempts   Int       @default(0)
  priority   Int       @default(5)
  startedAt  DateTime? @map("started_at")
  finishedAt DateTime? @map("finished_at")
  log        String?
  error      String?
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  video      Video     @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@index([videoId])
  @@index([type])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("jobs")
}
